<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="autonomous_wheelchair">

  <!-- Include Gazebo plugins -->
  <xacro:include filename="$(find wheelchair_description)/urdf/wheelchair.gazebo.xacro" />
  
  <!-- Include ros2_control description (DISABLED - using direct Gazebo plugin instead) -->
  <!-- Uncomment below to re-enable ros2_control if needed -->
  <!-- <xacro:include filename="$(find wheelchair_description)/urdf/wheelchair.ros2_control.xacro" /> -->

  <!-- ==================== PARAMETERS ==================== -->
  <xacro:property name="base_length" value="0.50"/>
  <xacro:property name="base_width" value="0.44"/>
  <xacro:property name="base_height" value="0.05"/>
  <xacro:property name="base_mass" value="10.0"/>
  
  <!-- Computed box inertial for chassis -->
  <!-- For box: I = m/12 * (dim1² + dim2²) -->
  <!-- h² = 0.035² = 0.001225, w² = 0.44² = 0.1936, l² = 0.5² = 0.25 -->
  <!-- Ixx = (10/12) * (0.001225 + 0.1936) = 0.16235416666666666 -->
  <!-- Iyy = (10/12) * (0.25 + 0.001225) = 0.20935416666666665 -->
  <!-- Izz = (10/12) * (0.25 + 0.1936) = 0.3696666666666667 -->
  <xacro:property name="Ixx_val" value="0.16235416666666666"/>
  <xacro:property name="Iyy_val" value="0.20935416666666665"/>
  <xacro:property name="Izz_val" value="0.3696666666666667"/>
  
  <!-- Wheel parameters -->
  <xacro:property name="wheel_radius_back" value="0.15"/>
  <xacro:property name="wheel_width_back" value="0.04"/>
  <xacro:property name="wheel_radius_front" value="0.095"/>
  <xacro:property name="wheel_width_front" value="0.03"/>
  <xacro:property name="wheel_mass" value="0.5"/>
  
  <!-- Wheel positions (relative to base_uplayer_link) -->
  <xacro:property name="wheel_separation_x" value="0.5"/>  <!-- Distance between front and back wheels -->
  <xacro:property name="wheel_separation_y" value="0.52"/>  <!-- Distance between left and right wheels -->
  <xacro:property name="wheel_base_x" value="0.25"/>  <!-- Half of wheel_separation_x -->
  <xacro:property name="wheel_base_y" value="0.26"/>  <!-- Half of wheel_separation_y -->
  
  <!-- Base link height offset -->
  <xacro:property name="base_height_offset" value="0.21"/>

  <!-- ==================== BASE FRAME (chassis) ==================== -->
  <!-- Note: Original had no inertial, but Gazebo Fortress requires it -->
  <link name="chassis">
    <visual>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <geometry>
        <box size="0.001 0.001 0.001"/>
      </geometry>
      <material name="transparent">
        <color rgba="0.0 0.0 0.0 0.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <geometry>
        <box size="0.001 0.001 0.001"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="${base_mass}"/>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <inertia
        ixx="${Ixx_val}" ixy="0.0" ixz="0.0"
        iyy="${Iyy_val}" iyz="0.0"
        izz="${Izz_val}"/>
    </inertial>
  </link>

  <!-- ==================== BASE UPPER LINK (main platform) ==================== -->
  <link name="base_uplayer_link">
    <visual name="chassis_visual">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="${base_length} ${base_width} ${base_height}"/>
      </geometry>
      <material name="orange">
        <color rgba="1.0 0.5 0.0 1.0"/>
      </material>
    </visual>
    
    <inertial>
      <mass value="${base_mass}"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <!-- Using computed box inertia values (same as chassis since same dimensions) -->
      <inertia
        ixx="${Ixx_val}" ixy="0" ixz="0"
        iyy="${Iyy_val}" iyz="0"
        izz="${Izz_val}"/>
    </inertial>

    <collision name="collision">
      <geometry>
        <box size="${base_length} ${base_width} ${base_height}"/>
      </geometry>
    </collision>

    <collision name="caster_collision">
      <origin xyz="-0.2 0 -0.05" rpy="0 0 0"/>
      <geometry>
        <sphere radius="0.05"/>
      </geometry>
      <surface>
        <friction>
          <ode>
            <mu>0</mu>
            <mu2>0</mu2>
            <slip1>1.0</slip1>
            <slip2>1.0</slip2>
          </ode>
        </friction>
      </surface>
    </collision>

    <visual name="caster_visual">
      <origin xyz="0.0 0 -0.05" rpy="0 0 0"/>
      <geometry>
        <sphere radius="0.05"/>
      </geometry>
    </visual>
  </link>

  <joint name="base_joint" type="fixed">
    <origin xyz="0.0 0.0 ${base_height_offset}" rpy="0.0 0.0 0.0"/>
    <parent link="chassis"/>
    <child link="base_uplayer_link"/>
  </joint>

  <!-- ==================== WHEELS ==================== -->
  <!-- Wheel macro for back wheels -->
  <xacro:macro name="wheel_back" params="name x y">
    <link name="${name}_link">
      <inertial>
        <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
        <mass value="${wheel_mass}"/>
        <!-- For cylinder: Ixx = Iyy = m/12 * (3*r² + h²), Izz = m*r²/2 -->
        <!-- Back wheel: r=0.15, h=0.04, m=0.5 -->
        <!-- Ixx = Iyy = 0.5/12 * (3*0.0225 + 0.0016) = 0.0029 -->
        <!-- Izz = 0.5 * 0.0225 / 2 = 0.0056 -->
        <inertia ixx="0.0029" ixy="0.0" ixz="0.0" iyy="0.0029" iyz="0.0" izz="0.0056"/>
      </inertial>
      <visual name="${name}_visual">
        <origin xyz="0.0 0.0 0.0" rpy="1.570795 0.0 0.0"/>
        <geometry>
          <cylinder length="${wheel_width_back}" radius="${wheel_radius_back}"/>
        </geometry>
        <material name="black">
          <color rgba="0 0 0 1"/>
        </material>
      </visual>
      <collision name="${name}_collision">
        <origin xyz="0.0 0.0 0.0" rpy="1.570795 0.0 0.0"/>
        <geometry>
          <cylinder length="${wheel_width_back}" radius="${wheel_radius_back}"/>
        </geometry>
      </collision>
    </link>

    <joint name="${name}_joint" type="continuous">
      <origin xyz="${x} ${y} 0.0" rpy="0.0 0.0 0.0"/>
      <parent link="base_uplayer_link"/>
      <child link="${name}_link"/>
      <axis xyz="0.0 1.0 0.0"/>
    </joint>
  </xacro:macro>

  <!-- Wheel macro for front wheels -->
  <xacro:macro name="wheel_front" params="name x y">
    <link name="${name}_link">
      <inertial>
        <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
        <mass value="${wheel_mass}"/>
        <!-- For cylinder: Ixx = Iyy = m/12 * (3*r² + h²), Izz = m*r²/2 -->
        <!-- Front wheel: r=0.095, h=0.03, m=0.5 -->
        <!-- Ixx = Iyy = 0.5/12 * (3*0.009025 + 0.0009) = 0.0012 -->
        <!-- Izz = 0.5 * 0.009025 / 2 = 0.0023 -->
        <inertia ixx="0.0012" ixy="0.0" ixz="0.0" iyy="0.0012" iyz="0.0" izz="0.0023"/>
      </inertial>
      <visual name="${name}_visual">
        <origin xyz="0.0 0.0 0.0" rpy="1.570795 0.0 0.0"/>
        <geometry>
          <cylinder length="${wheel_width_front}" radius="${wheel_radius_front}"/>
        </geometry>
        <material name="black">
          <color rgba="0 0 0 1"/>
        </material>
      </visual>
      <collision name="${name}_collision">
        <origin xyz="0.0 0.0 0.0" rpy="1.570795 0.0 0.0"/>
        <geometry>
          <cylinder length="${wheel_width_front}" radius="${wheel_radius_front}"/>
        </geometry>
      </collision>
    </link>

    <joint name="${name}_joint" type="continuous">
      <origin xyz="${x} ${y} 0.0" rpy="0.0 0.0 0.0"/>
      <parent link="base_uplayer_link"/>
      <child link="${name}_link"/>
      <axis xyz="0.0 1.0 0.0"/>
    </joint>
  </xacro:macro>

  <!-- Create wheels -->
  <!-- Back right wheel (wheel1) -->
  <xacro:wheel_back name="wheel1" x="-${wheel_base_x}" y="-${wheel_base_y}"/>
  <!-- Back left wheel (wheel2) -->
  <xacro:wheel_back name="wheel2" x="-${wheel_base_x}" y="${wheel_base_y}"/>
  <!-- Front right wheel (wheel3) -->
  <xacro:wheel_front name="wheel3" x="${wheel_base_x}" y="-${wheel_base_y}"/>
  <!-- Front left wheel (wheel4) -->
  <xacro:wheel_front name="wheel4" x="${wheel_base_x}" y="${wheel_base_y}"/>

  <!-- ==================== IMU SENSOR ==================== -->
  <link name="imu_sensor_link">
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.02 0.02 0.02"/>
      </geometry>
    </collision>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.02 0.02 0.02"/>
      </geometry>
      <material name="yellow">
        <color rgba="1 1 0 1"/>
      </material>
    </visual>
    <inertial>
      <mass value="0.001"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="0.00000015" ixy="0" ixz="0" iyy="0.00000015" iyz="0" izz="0.00000015"/>
    </inertial>
  </link>

  <joint name="imu_sensor_joint" type="fixed">
    <axis xyz="0 0 1"/>
    <origin xyz="0.0 0.0 0.23" rpy="0.0 0.0 0.0"/>
    <parent link="chassis"/>
    <child link="imu_sensor_link"/>
  </joint>

  <!-- ==================== CAMERA STAND & CAMERA ==================== -->
  <link name="camera_stand_link">
    <inertial>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <mass value="1.0"/>
      <inertia ixx="0.01" ixy="0.0" ixz="0.0" iyy="0.01" iyz="0.0" izz="0.01"/>
    </inertial>
    <visual>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <geometry>
        <box size="0.05 0.05 0.435"/>
      </geometry>
      <material name="gray">
        <color rgba="0.2 1.0 0.5 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <geometry>
        <box size="0.05 0.04 0.435"/>
      </geometry>
    </collision>
  </link>

  <joint name="camera_stand_joint" type="fixed">
    <origin xyz="-0.22 0.0 0.58" rpy="0.0 0.0 0.0"/>
    <parent link="chassis"/>
    <child link="camera_stand_link"/>
  </joint>

  <!-- Camera Link -->
  <link name="camera_link">
    <inertial>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <mass value="1.0"/>
      <inertia ixx="0.01" ixy="0.0" ixz="0.0" iyy="0.01" iyz="0.0" izz="0.01"/>
    </inertial>
    <visual name="camera_visual">
      <origin xyz="0.0 0.00 0.03" rpy="0 0 0.0"/>
      <geometry>
        <box size="0.1 0.2 0.04"/>
      </geometry>
      <material name="camera_material">
        <color rgba="0.0 0.0 0.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0.0 0.00 0.03" rpy="0 0 0.0"/>
      <geometry>
        <box size="0.1 0.2 0.04"/>
      </geometry>
    </collision>
  </link>

  <joint name="camera_joint" type="fixed">
    <parent link="camera_stand_link"/>
    <child link="camera_link"/>
    <origin xyz="0.0 0.0 0.21" rpy="0 0.0 0.0"/>
  </joint>

  <!-- Kinect Optical Frame -->
  <joint name="kinect_optical_joint" type="fixed">
    <origin xyz="0 0 0" rpy="-1.5707 0 -1.5707"/>
    <parent link="camera_link"/>
    <child link="kinect_optical"/>
  </joint>

  <link name="kinect_optical">
    <inertial>
      <mass value="0.0001"/>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <inertia
        ixx="0.00000001" ixy="0.0" ixz="0.0"
        iyy="0.00000001" iyz="0.0"
        izz="0.00000001"/>
    </inertial>
  </link>

  <!-- ==================== LIDAR SENSOR ==================== -->
  <link name="base_laser">
    <visual>
      <origin xyz="-0.015 0.00 0.015" rpy="0 0 0.0"/>
      <geometry>
        <cylinder length="0.05" radius="0.05"/>
      </geometry>
      <material name="black">
        <color rgba="0 0 0 1"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <geometry>
        <box size="0.2 0.1 0.04"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="0.1"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="1e-6" ixy="0" ixz="0" iyy="1e-6" iyz="0" izz="1e-6"/>
    </inertial>
  </link>

  <joint name="base_link_to_lidar" type="fixed">
    <parent link="chassis"/>
    <child link="base_laser"/>
    <!-- Position: camera_stand is at (-0.22, 0.0, 0.58), lidar is at (0.015, 0.0, 0.18) relative to camera_stand -->
    <!-- So lidar absolute position: (-0.22+0.015, 0.0, 0.58+0.18) = (-0.205, 0.0, 0.76) -->
    <origin xyz="-0.205 0.0 0.76" rpy="0.0 0.0 0.0"/>
  </joint>

  <!-- ==================== STRUCTURAL COMPONENTS (simplified) ==================== -->
  <!-- Note: Keeping essential structure, can add more details later if needed -->
  <!-- Seat link -->
  <link name="seat_link">
    <inertial>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <mass value="1.0"/>
      <inertia ixx="0.01" ixy="0.0" ixz="0.0" iyy="0.01" iyz="0.0" izz="0.01"/>
    </inertial>
    <visual>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <geometry>
        <box size="0.4 0.5 0.04"/>
      </geometry>
      <material name="black">
        <color rgba="0.0 0.0 0.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <geometry>
        <box size="0.4 0.5 0.04"/>
      </geometry>
    </collision>
  </link>

  <joint name="seat_joint" type="fixed">
    <origin xyz="-0.04 0.0 0.25" rpy="0.0 0.0 0.0"/>
    <parent link="base_uplayer_link"/>
    <child link="seat_link"/>
  </joint>

  <!-- Back link -->
  <link name="back_link">
    <inertial>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <mass value="1.0"/>
      <inertia ixx="0.01" ixy="0.0" ixz="0.0" iyy="0.01" iyz="0.0" izz="0.01"/>
    </inertial>
    <visual>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <geometry>
        <box size="0.04 0.41 0.41"/>
      </geometry>
      <material name="red">
        <color rgba="1.0 0.0 0.0 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <geometry>
        <box size="0.02 0.41 0.41"/>
      </geometry>
    </collision>
  </link>

  <joint name="back_joint" type="fixed">
    <origin xyz="-0.2 0.0 0.22" rpy="0.0 0.0 0.0"/>
    <parent link="seat_link"/>
    <child link="back_link"/>
  </joint>

</robot>

